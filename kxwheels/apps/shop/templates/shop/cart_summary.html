{% extends "shop/base.html" %}
{% load shop_tags shop_filters %}
{% load shop_tags shop_filters staticfiles %}
{% block content %}
    <div class="grid_16 shopping-cart-sec">
    <h2>Shopping Cart </h2>
    <table width="940" id="shopping_cart">

        <thead>

            <tr>
                <th width="">Item #</th>
                <th width="">Item name</th>
                <th width="">Unit Price</th>
                <th width="">Make</th>
                <th width="">Year</th>
                <th width="">Model</th>
                <th width="">Qty</th>
                <th width="">Item total</th>
                <th width=""></th>
            </tr>
        </thead>
    
        <tbody>
            {% for item in cart.items.all %}
            <tr>
    	        <td>{{ item.product.sku }}</td>
                <td width="10px"><nobr>
        			{{ item.product.name|truncatewords:4 }}
        			<ul>{% for item_opt in item.options.all %}
                        <li>
                            {{ item_opt.name }}: {{ item_opt.value }}
                            {% if item_opt.price_adjustment > 0 %}
                            ({{ item_opt.price_adjustment|currency }})
                            {% endif %}
                        </li>{% endfor %}
        			</ul></nobr>
                </td>
                <td>{{ item.get_price|currency }}</td>
                <td>{{ item.make }}</td>
                <td> {{ item.year }}</td>
                <td >{{ item.make }}</td>
                <td ><nobr>
        			<form action="{% url "shop_cartitem_update" %}" method="post"> {% csrf_token %}
        				<input type="hidden" name="return_path" value="{% url "shop_cart_summary" %}">
        				<input type="hidden" name="object_id" value="{{ item.pk }}">
        				<input type="text" name="quantity" value="{{ item.qty }}" size="2" />
        				<input name="update_item" value="Update" type="submit">
        			</form></nobr>
                </td>
                <td class="align_right">{{ item.get_extended_price|currency }}</td>
                <td><nobr>
                    <form action="{% url "shop_cartitem_delete" %}" method="post"> {% csrf_token %}
                        <input type="hidden" name="object_id" value="{{ item.pk }}">
                        <input name="delete_item" value="" type="submit" class="del">
                    </form></nobr>
        		</td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="8" class="align_right">Subtotal</td>
                <td class="align_right">{{ cart.get_subtotal|currency }}</td>
            <tr>


            {% for tax in cart.get_tax_summary %}
            <tr>
                <td colspan="8" class="align_right">{{ tax.0 }}: </td>
                <td class="align_right">{{ tax.1|currency }}</td>
            </tr>
            {% endfor %}
            
            {% if cart.discount %}
            <tr>
                <td colspan="8" class="align_right">Discount: </td>
                <td colspan="1" class="align_right" width="145">
                        {{ cart.get_discount_summary.1|currency }}</td>
            </tr>
            {% endif %}

            <tr>
                <td colspan="8" class="align_right">Shipping (
                    {{ cart.get_shipping_summary.0 }} {{ cart.get_shipping_summary.1 }} days): </td>
                <td colspan="1" class="align_right">{{ cart.get_shipping_summary.2|currency }}</td>
            </tr>

            <tr>
                <td colspan="8" class="align_right total">Total: </td>
                <td class="align_right total-a"><span id="cart_total">{{ cart.get_total|currency }}</span></td>
            </tr>
        </tbody>
    </table>
    </div>

    <div class="clear"></div>
    <div class="grid_16 payment-method"> <h2> Select The Payment Method:{% if user.is_authenticated and user.is_active %}
            <select id="show" class="w_btn" >
                    <option value="0"> - Select Payment Method - </option>
                    <option value="1"> - PayPal - </option>
                    <option value="2"> - Card - </option>
                </select>
        {% else %}
            <select id="show1" class="w_btn show_model" >
                    <option value="0"> - Select Payment Method - </option>
                    <option value="1"> - PayPal - </option>
                    <option value="2"> - Card - </option>
                </select>
        {% endif %}</h2>
    </div>
    <div class="grid_16 submit_bar shopping-cart-sec" style="display:none;" id="paypal">
        <h2>Click The Button to Pay by PayPal</h2>
        {{form}}
        {{ form.render }}
    </div>
    <div id = 'card' style="visibility: hidden;" class="grid_16 shopping-cart-sec">
        <h2>Fill the Card Credentials for Payment.</h2>
            <form class="shopping-cart-form" id="myform" action="{% url "shop_card" %}" method="post"  >
                {% csrf_token %}
            <div class="payment-cart">
                <div class="form_row"><label>Card No: </label><input type="text" name="card_num" id="card_num" placeholder="Compulsory Field" ></div>
                <div class="form_row"><label>CVV: </label><input type="text" name="cvv" id="cvv" placeholder="Compulsory Field" ></div>
                <div class="form_row"><label>Expiry Date:</label><input type="text" name="expiry" id="expiry" placeholder="Compulsory Field" ></div>
                <div class="form_row"><label>Name: </label><input type="text" id="name" name="u_name" placeholder="Optional Field" ></div>
                <div class="form_row"><label>Address: </label><input type="text" id="address" name="address" placeholder="Optional Field" ></div>
                <div class="payment-btn"><input type="submit" value="Submit" name="submit" id="submit" class="button"/></div>
                </div>
            </form>
        </div>

    <div id="errors" >
        <div>
            <div id="buy-wheel-popup" style="display: none;">
                <dialog id="window" >
                    <div><p><span id="exit" style="width:20px; heigh:20px;" class="show_model_cancel">Ã—</span>
                                            </p><h3>Enter The Valid Email to Check Out:</h3><p></p></div>
                    <form  action="{% url "shop_cart_summary_email" %}" id="email_form">
                    <input type="hidden" name="csrfmiddlewaretoken" id="token" value="{{ csrf_token }}">
                     <p class="value">
                        <strong> Enter Email Address to Check Out:</strong><input type="email" name="logout_email" id="logout_email" class="logout_email">
                        </p>

                        <input type="button" id="submit_email" class="button submit_email" value="Confirm to Proceed" />

                </form>

                </dialog>
            </div>
        </div>
        {% if error %}
            <h2 id="error"> {{ error }}</h2>
            <div  style="visibility: hidden;">
                <a href="http://127.0.0.1:8000/shop/cart/summary/" />
            </div>
        {% else %}
            <p></p>
        {% endif %}
    </div>
    <!--</div>-->
    <div class="clear"></div>
{% endblock %}

{% block extra_js %}
    <!--<script>-->
    <!--$('#submit').click(function(){-->
           <!--var val = $("#logout_email").val();-->
           <!--var token = $('#token').val();-->
           <!--var data= {"val":val , "csrfmiddlewaretoken": token};-->
           <!--$.ajax({-->
               <!--type:"POST",-->
               <!--url:$("#email_form").attr('action'),-->
               <!--data:data,-->
               <!--success:function(response) {-->
                        <!--alert('working Fine');-->
                    <!--}-->
                    <!--else{-->
                        <!--alert('Did Not Working Fine');-->
                    <!--}-->
            <!--});-->
     <!--});-->

      <!--$('#order').click(function(){-->
        <!--$("#paypal").attr('style',  'display:block');-->
           <!--var val = $("#order_post").val();-->
           <!--var data= cart.items;-->
           <!--$.ajax({-->
               <!--type:"POST",-->
               <!--url:'shop_payment_create',-->
               <!--data:data,-->
               <!--success:function(response) {-->

                    <!--}-->
              <!--});-->
    <!--paypal_dict = {-->

        <!--}-->
             <!--});-->
    <!--</script>-->
    <script>

     $( "body" ).delegate( "#myform", "submit", function(){
        if ($("#card_num").val().length === 0)
        {
            if ($("#cvv").val().length === 0){
                if ($("#expiry").val().length === 0){
                    document.getElementById('expiry').style.borderColor = "Red";
                    $("#expiry").attr("placeholder", "Missing Compulsory Field");
                    document.getElementById('cvv').style.borderColor = "Red";
                    $("#cvv").attr("placeholder", "Missing Compulsory Field");
                    document.getElementById('card_num').style.borderColor = "Red";
                    $("#card_num").attr("placeholder", "Missing Compulsory Field");
                }
                document.getElementById('cvv').style.borderColor = "Red";
                $("#cvv").attr("placeholder", "Missing Compulsory Field");
                document.getElementById('card_num').style.borderColor = "Red";
                $("#expiry").attr("placeholder", "Missing Compulsory Field");
            }
            if ($("#expiry").val().length === 0){
                    document.getElementById('expiry').style.borderColor = "Red";
                    $("#expiry").attr("placeholder", "Missing Compulsory Field");
                    document.getElementById('card_num').style.borderColor = "Red";
                    $("#card_num").attr("placeholder", "Missing Compulsory Field");
            }else{
                document.getElementById('card_num').style.borderColor = "Red";
                $("#card_num").attr("placeholder", "Missing Compulsory Field");
            }
            return false;
        }
        if ($("#cvv").val().length === 0)
        {
            if ($("#expiry").val().length === 0){
                document.getElementById('expiry').style.borderColor = "Red";
                $("#expiry").attr("placeholder", "Missing Compulsory Field");
                document.getElementById('cvv').style.borderColor = "Red";
                $("#cvv").attr("placeholder", "Missing Compulsory Field");
            }
            document.getElementById('cvv').style.borderColor = "Red";
            $("#cvv").attr("placeholder", "Missing Compulsory Field");
            return false;
        }
        if ($("#expiry").val().length === 0){
            document.getElementById('expiry').style.borderColor = "Red";
            $("#expiry").attr("placeholder", "Missing Compulsory Field");
            return false;
        }
        });

    $( "body" ).delegate( "#show", "change", function(){

           if($("#show").val() == 1 ){
                $('#paypal').attr('style', 'visibility: visible;');
                $('#paypal').attr('style', "display: block;");
                $('#card').attr('style', 'visibility: hidden;');
           }
           if($("#show").val() == 2){
                $('#paypal').attr('style', 'visibility: hidden;');
                $('#paypal').attr('style', "display: none;");
                $('#card').attr('style', 'visibility: visible;');
            }
        });
     <!--if($("#error").val()){-->
     <!--}-->
    var cart_total = ({{ cart.get_total }});
    
    var shipping_quotes = new Array();
    {% for sq in cart.shipping_quotes.all %}
    shipping_quotes.push([{{ sq.pk }}, "{{ sq.name }}", {{ sq.cost }}, "{{ sq.cost|currency }}"])
	{% endfor %}
        
    function displayTotal() {
        i = $("#id_shipping_option option:selected").index();
        new_total = cart_total+shipping_quotes[i][2];
        $("#cart_total").text("$"+new_total.toFixed(2));
    }
    
    $(function() {
        displayTotal();
        var options = [];
        $.each(shipping_quotes, function(i, value) {
            options.push('<option value="'+shipping_quotes[i][0]+'">'+shipping_quotes[i][1]+' ('+shipping_quotes[i][3]+')'+'</option>');
        });
        $("#id_shipping_option").html(options.join(''));
        $("#id_shipping_option").change(function(){ displayTotal() });
    });

    var dialog = document.getElementById('window');
    $('body').delegate(".show_model", "change" , function() {
        dialog.show();
        $('#buy-wheel-popup').attr('style', 'display:block;');
    });

    $('#email_form').on('keyup keypress', function(e) {
          var keyCode = e.keyCode || e.which;
          if (keyCode === 13) {
            e.preventDefault();
            return false;
          }
    });

    $('body').delegate(".submit_email", "click" , function() {
           var val = $(".logout_email").val();
           if (val == ''){
            alert('Please provide Email to Proceed');
           }
           else{
               var token = $('#token').val();
               var data= {"val":val , "csrfmiddlewaretoken": token};
               $.ajax({
                   type:"POST",
                   url:$("#email_form").attr('action'),
                   data:data,
                   success:function(response) {
                            $(".logout_email").val('');
                            $(".logout_email_hidden").val('click');
                            $(".show_model_cancel").trigger('click');
                            if($("#show1").val() == 1){
                               $('#buy-wheel-popup').attr('style', 'display:none;');
                               $('#paypal').attr('style', 'visibility: visible;');
                               $('#card').attr('style', 'visibility: hidden;');
                           }
                           if($("#show1").val() == 2){
                                $('#buy-wheel-popup').attr('style', 'display:none;');
                               $('#paypal').attr('style', "display: none;");
                               $('#card').attr('style', 'visibility: visible;');
                           }
                   }
               });
           }
    });
    $('body').delegate(".show_model_cancel", "click" , function()  {
        dialog.close();
     });
    </script>
{% endblock %}
